# docker-compose.yml 설명:
# docker-compose는 여러 컨테이너를 함께 실행하는 도구입니다.
# 한 번의 명령으로 애플리케이션과 데이터베이스를 함께 실행할 수 있습니다.
# Docker Compose v2에서는 version 필드가 더 이상 필요하지 않습니다.

# 서비스 정의 (컨테이너 목록)
services:
  
  # MariaDB 데이터베이스 서비스
  db:
    image: mariadb:10.11
    container_name: lotto-db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: lotto
      MYSQL_USER: ${DB_USERNAME:-root}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    ports:
      - "3307:3306"  # 호스트 3307 포트 -> 컨테이너 3306 포트 (로컬 MariaDB와 충돌 방지)
    volumes:
      - db_data:/var/lib/mysql  # Docker가 관리하는 볼륨 (데이터 영구 저장)
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Spring Boot 애플리케이션 서비스
  app:
    build:
      context: .  # Dockerfile이 있는 디렉토리
      dockerfile: Dockerfile  # 사용할 Dockerfile 이름
    container_name: lotto-app
    restart: always  # 컨테이너가 종료되면 자동으로 다시 시작
    depends_on:
      db:
        condition: service_healthy  # DB가 준비될 때까지 대기
    ports:
      - "8080:8080"  # 호스트 8080 포트 -> 컨테이너 8080 포트
    
    # 환경 변수 설정
    env_file:
      - .env  # .env 파일에서 환경 변수 로드
    environment:
      # Spring Boot 프로파일을 docker로 설정하여 application-docker.properties 사용
      - SPRING_PROFILES_ACTIVE=docker
      # DB 연결 정보 (환경 변수로 주입)
      - DB_USERNAME=${DB_USERNAME:-root}
      - DB_PASSWORD=${DB_PASSWORD}
      # 이메일 설정 (환경 변수로 주입)
      - MAIL_USERNAME=${MAIL_USERNAME}
      - MAIL_PASSWORD=${MAIL_PASSWORD}
    
    # 네트워크: 같은 docker-compose 네트워크에서 db 서비스 이름으로 접근 가능

# 볼륨 정의 (데이터 영구 저장)
volumes:
  db_data:  # MariaDB 데이터를 저장하는 볼륨

# docker-compose 사용법:
# 1. 빌드 및 실행: docker-compose up -d
# 2. 중지: docker-compose down
# 3. 로그 확인: docker-compose logs -f
# 4. 상태 확인: docker-compose ps
# 5. 재빌드: docker-compose up --build
# 6. 볼륨 포함 삭제: docker-compose down -v (주의: 데이터 삭제됨)

# 데이터 마이그레이션:
# 1. 기존 로컬 DB에서 덤프: mysqldump -u root -p1234 lotto > lotto_backup.sql
# 2. Docker DB 실행: docker-compose up -d db
# 3. 데이터 복원: docker exec -i lotto-db mysql -u root -p1234 lotto < lotto_backup.sql
