# docker-compose.yml 설명:
# docker-compose는 여러 컨테이너를 함께 실행하는 도구입니다.
# 한 번의 명령으로 애플리케이션과 데이터베이스를 함께 실행할 수 있습니다.
# Docker Compose v2에서는 version 필드가 더 이상 필요하지 않습니다.

# 서비스 정의 (컨테이너 목록)
services:
  
  # MariaDB 데이터베이스 서비스
  db:
    image: mariadb:10.11
    container_name: lotto-db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: lotto
      MYSQL_USER: ${DB_USERNAME:-root}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    ports:
      - "3307:3306"  # 호스트 3307 포트 -> 컨테이너 3306 포트 (로컬 MariaDB와 충돌 방지)
    volumes:
      - db_data:/var/lib/mysql  # Docker가 관리하는 볼륨 (데이터 영구 저장)
    networks:
      - lotto-network
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Spring Boot 애플리케이션 서비스
  app:
    image: jongseungpark/lotto-web:latest
    container_name: lotto-app
    restart: always  # 컨테이너가 종료되면 자동으로 다시 시작
    depends_on:
      db:
        condition: service_healthy  # DB가 준비될 때까지 대기
    ports:
      - "8080:8080"  # 호스트 8080 포트 -> 컨테이너 8080 포트
    
    # 환경 변수 설정
    env_file:
      - .env  # .env 파일에서 환경 변수 로드
    environment:
      # Spring Boot 프로파일을 prod로 설정하여 application-prod.properties 사용
      - SPRING_PROFILES_ACTIVE=prod
      # DB 연결 정보 (환경 변수로 주입)
      - SPRING_DATASOURCE_URL=jdbc:mariadb://db:3306/lotto?useUnicode=true&characterEncoding=UTF-8
      - SPRING_DATASOURCE_USERNAME=${DB_USERNAME:-root}
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD}
      # 이메일 설정 (환경 변수로 주입)
      - SPRING_MAIL_USERNAME=${MAIL_USERNAME}
      - SPRING_MAIL_PASSWORD=${MAIL_PASSWORD}
    
    volumes:
      - ./logs:/app/logs
    networks:
      - lotto-network

# 볼륨 정의 (데이터 영구 저장)
volumes:
  db_data:  # MariaDB 데이터를 저장하는 볼륨

# 네트워크 정의
networks:
  lotto-network:
    driver: bridge
