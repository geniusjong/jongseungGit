name: CI Build and Test

# 트리거 설정: 언제 실행할지 조건
on:
  push:
    branches: [ main, master ]  # main 또는 master 브랜치에 푸시하면 실행
  pull_request:
    branches: [ main, master ]  # Pull Request 생성/업데이트 시에도 실행

# 작업 정의
jobs:
  build:
    name: Build, Test, and Quality Check
    runs-on: ubuntu-latest  # GitHub Actions의 무료 Ubuntu 서버 사용
    
    steps:
      # 1단계: 코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2단계: Java 11 설정
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'  # eclipse-temurin 사용 (Dockerfile과 동일)
          cache: 'maven'  # Maven 의존성 캐시 (빌드 속도 향상)
          cache-dependency-path: 'lottoSeriveStudy/lotto_web/pom.xml'  # Maven 캐시 경로 지정
      
      # 3단계: 테스트 실행 (JaCoCo 테스트 커버리지 파일 생성)
      - name: Run Tests with Coverage
        working-directory: lottoSeriveStudy/lotto_web
        run: mvn clean test jacoco:report
      
      # 4단계: 테스트 커버리지 리포트 업로드 (GitHub Actions Artifact)
      - name: Upload Test Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-coverage-report
          path: lottoSeriveStudy/lotto_web/target/site/jacoco/
          retention-days: 30
      
      # 5단계: 테스트 결과 확인
      - name: Verify Test Results
        working-directory: lottoSeriveStudy/lotto_web
        run: |
          if [ -f target/surefire-reports/TEST-*.xml ]; then
            echo "? 테스트 리포트 생성 완료"
            echo "테스트 리포트 위치: target/surefire-reports/"
            echo "커버리지 리포트 위치: target/site/jacoco/index.html"
          else
            echo "?? 테스트 리포트를 찾을 수 없습니다"
          fi
      
      # 6단계: 코드 품질 검사 (Checkstyle) - 경고만 표시
      - name: Code Quality Check with Checkstyle
        working-directory: lottoSeriveStudy/lotto_web
        run: mvn checkstyle:check || true  # Checkstyle 실패해도 빌드 계속 진행
        continue-on-error: true
      
      # 7단계: Maven 빌드 (JAR 생성)
      - name: Build JAR with Maven
        working-directory: lottoSeriveStudy/lotto_web
        run: mvn clean package -DskipTests
      
      # 8단계: 빌드 결과 확인
      - name: Verify JAR file
        working-directory: lottoSeriveStudy/lotto_web
        run: |
          if [ ! -f target/lotto-web-1.0.0.jar ]; then
            echo "? JAR 파일이 생성되지 않았습니다!"
            exit 1
          else
            echo "? JAR 파일 생성 성공!"
            ls -lh target/lotto-web-1.0.0.jar
          fi
      
      # 9단계: Docker Hub 로그인 (push 이벤트에서만 실행)
      - name: Login to Docker Hub
        if: github.event_name == 'push'
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      # 10단계: Docker 이미지 빌드 및 태그 설정
      - name: Build Docker image
        working-directory: lottoSeriveStudy/lotto_web
        run: |
          docker build -t jongseungpark/lotto-web:latest .
          docker tag jongseungpark/lotto-web:latest jongseungpark/lotto-web:${{ github.sha }}
          echo "? Docker 이미지 빌드 성공!"
      
      # 11단계: Docker 이미지 확인
      - name: Verify Docker image
        run: |
          docker images jongseungpark/lotto-web:latest
          echo "? Docker 이미지 확인 완료!"
      
      # 12단계: Docker Hub에 푸시 (push 이벤트에서만 실행)
      - name: Push to Docker Hub
        if: github.event_name == 'push'
        run: |
          docker push jongseungpark/lotto-web:latest
          docker push jongseungpark/lotto-web:${{ github.sha }}
          echo "? Docker Hub 푸시 성공!"
